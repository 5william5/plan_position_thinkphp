{extend name="public/base"/}

{block name="seo"}
<title>订单管理系统</title>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
{/block}

{block name="content"}
<div class="layui-body">
    <div style="padding: 15px;">
		<div class="layui-row headBar layui-form">
			<div class="layui-col-md2">
				<div class="layui-row">
					<div class="layui-col-md4"><span>登录帐号:</span></div>
					<div class="layui-col-md8">
						<input type="text" class="layui-input" id="searchAccount" name="searchAccount" placeholder="请填写">
					</div>
				</div>
			</div>
			<div class="layui-col-md2">
				<div class="layui-row">
					<div class="layui-col-md4"><span>用户名:</span></div>
					<div class="layui-col-md8">
						<input type="text" class="layui-input" id="searchName" name="searchName" placeholder="请填写">
					</div>
				</div>
			</div>
			<div class="layui-col-md2">
				<div class="layui-row">
					<div class="layui-col-md4"><span>电话:</span></div>
					<div class="layui-col-md8">
						<input type="text" class="layui-input" id="searchPhone" name="searchPhone" placeholder="请填写">
					</div>
				</div>
			</div>
			<!-- <div class="layui-col-md2"> -->
				<!-- <div class="layui-row"> -->
					<!-- <div class="layui-col-md4"><span>角色:</span></div> -->
					<!-- <div class="layui-col-md8"> -->
						<!-- <select id='searchGroupId' name="searchGroupId" lay-verify="required"> -->
							<!-- <option value=""></option> -->
							<!-- {volist name="groupList" id="gpList"} -->
								<!-- <option value="{$gpList.id}">{$gpList.title}</option> -->
							<!-- {/volist} -->
						<!-- </select> -->
					<!-- </div> -->
				<!-- </div> -->
			<!-- </div> -->
			<div class="layui-col-md2 layui-col-md-offset4">
				<button class="layui-btn layui-btn-fluid" id="search" >搜索</button>
			</div> 
		</div>
		<hr class="layui-bg-black">
		<div class="layui-row">
			<div class="layui-col-md4">
				<button class="layui-btn" id="addUserBut">添加</button>
			</div> 
		</div>
		<table id="UserList" lay-filter="UserList"></table>
				
	</div>
</div>


<div id="addUserInfo" style="display:none;padding:15px;padding-right:50px;">
	<div class="layui-form">
	  <div class="layui-form-item">
		<label class="layui-form-label">登录帐号</label>
		<div class="layui-input-block">
		  <input type="text" name="account" required  lay-verify="required|account" placeholder="请输入英文加数字" autocomplete="off" class="layui-input">
		</div>
	  </div>
	  <div class="layui-form-item">
		<label class="layui-form-label">用户名</label>
		<div class="layui-input-block">
		  <input type="text" name="name" required lay-verify="required|name" placeholder="请输入中文名字" autocomplete="off" class="layui-input">
		</div>
	  </div>
	  <div class="layui-form-item">
		<label class="layui-form-label">电话</label>
		<div class="layui-input-block">
		  <input type="text" name="phone" required lay-verify="required|phone" placeholder="请输入手机号" autocomplete="off" class="layui-input">
		</div>
	  </div>
	  <!-- <div class="layui-form-item"> -->
		<!-- <label class="layui-form-label">角色</label> -->
		<!-- <div class="layui-input-block"> -->
			<!-- {volist name="groupList" id="gpList"} -->
				<!-- <input type="checkbox" name="group_id[]" value="{$gpList.id}" title="{$gpList.title}">  -->
			<!-- {/volist} -->
		<!-- </div> -->
	  <!-- </div> -->
	  <div class="layui-form-item">
		<label class="layui-form-label">启用状态</label>
		<div class="layui-input-block">
		  <select name="status" lay-verify="required">
			<option value="">请选择</option>
			<option value="1">启用</option>
			<option value="0">停用</option>
		  </select>
		</div>
	  </div>
	  <div class="layui-form-item">
		<label class="layui-form-label">密码</label>
		<div class="layui-input-block">
		  <input type="password" name="password" required lay-verify="required|password" placeholder="请输入密码" autocomplete="off" class="layui-input">
		</div>
	  </div>
	  <div class="layui-form-item">
		<div class="layui-input-block">
		  <button class="layui-btn" lay-submit lay-filter="addSubmit">提交</button>
		</div>
	  </div>
	</div>
</div>
<div id="editUserInfo" style="display:none;padding:15px;padding-right:50px;">
	<div class="layui-form" lay-filter="editUserForm">
	  <div class="layui-form-item">
		<label class="layui-form-label">用户ID</label>
		<div class="layui-input-block">
		  <input type="text" name="id" required readonly lay-verify="required" placeholder="请输入英文加数字" autocomplete="off" class="layui-input layui-disabled">
		</div>
	  </div>
	  <div class="layui-form-item">
		<label class="layui-form-label">登录帐号</label>
		<div class="layui-input-block">
		  <input type="text" name="account" required readonly lay-verify="required|account" placeholder="请输入英文加数字" autocomplete="off" class="layui-input layui-disabled">
		</div>
	  </div>
	  <div class="layui-form-item">
		<label class="layui-form-label">用户名</label>
		<div class="layui-input-block">
		  <input type="text" name="name" required lay-verify="required|name" placeholder="请输入中文名字" autocomplete="off" class="layui-input">
		</div>
	  </div>
	  <div class="layui-form-item">
		<label class="layui-form-label">电话</label>
		<div class="layui-input-block">
		  <input type="text" name="phone" required lay-verify="required|phone" placeholder="请输入手机号" autocomplete="off" class="layui-input">
		</div>
	  </div>
	  <!-- <div class="layui-form-item"> -->
		<!-- <label class="layui-form-label">角色</label> -->
		<!-- <div class="layui-input-block"> -->
		  <!-- {volist name="groupList" id="gpList"} -->
				<!-- <input type="checkbox" name="group_id[]" value="{$gpList.id}" title="{$gpList.title}">  -->
			<!-- {/volist} -->
		<!-- </div> -->
	  <!-- </div> -->
	  <div class="layui-form-item">
		<label class="layui-form-label">启用状态</label>
		<div class="layui-input-block">
		  <select name="status" lay-verify="required">
			<option value="1">启用</option>
			<option value="0">停用</option>
		  </select>
		</div>
	  </div>
	  <div class="layui-form-item">
		<div class="layui-input-block">
		  <button class="layui-btn" lay-submit lay-filter="editSubmit">提交</button>
		</div>
	  </div>
	</div>
</div>
<div id="setAuthInfo" style="display:none;padding:15px;padding-right:50px;">
	<div class="layui-form" lay-filter="setAuthForm">
	  <div class="layui-form-item">
		<label class="layui-form-label">用户ID</label>
		<div class="layui-input-block">
		  <input type="text" name="id"  readonly lay-verify="" placeholder="请输入英文加数字" autocomplete="off" class="layui-input layui-disabled">
		</div>
	  </div>
	  <div class="layui-form-item">
		<label class="layui-form-label">登录帐号</label>
		<div class="layui-input-block">
		  <input type="text" name="account"  readonly lay-verify="" placeholder="请输入英文加数字" autocomplete="off" class="layui-input layui-disabled">
		</div>
	  </div>
	  <div class="layui-form-item">
		<label class="layui-form-label">用户名</label>
		<div class="layui-input-block">
		  <input type="text" name="name"  readonly lay-verify="" placeholder="请输入中文名字" autocomplete="off" class="layui-input layui-disabled">
		</div>
	  </div>
	  <div class="layui-form-item">
		<label class="layui-form-label">角色</label>
		<div class="layui-input-block">
		  {volist name="groupList" id="gpList"}
				<input type="checkbox" name="group_id[]" value="{$gpList.id}" title="{$gpList.title}"> 
			{/volist}
		</div>
	  </div>
	  <div class="layui-form-item">
		<div class="layui-input-block">
		  <button class="layui-btn" lay-submit lay-filter="authSubmit">提交</button>
		</div>
	  </div>
	</div>
</div>
{/block}

{block name="js"}
<!--请在下方写此页面业务相关的脚本-->
<style type="text/css">
.headBar{
	text-align:center;
	margin-bottom:10px;
	}
</style>
<!-- 状态列模板 -->
<script type="text/html" id="switchTpl">
	{{#  if(d.id != 1){ }}
	  <input type="checkbox" name="status" value="{{d.id}}" lay-skin="switch" lay-text="启用|停用" lay-filter="status"  {{ d.status == 1 ? 'checked' : '' }}>
	{{#  } }} 
</script>
<!-- 操作列模板 -->
<script type="text/html" id="setcol">
	{{#  if(d.id != 1){ }}
	  <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
	  <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="setAuth">设置角色</a>
	  <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="passwordCh">更改密码</a>
	  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="dele">删除</a>
	{{#  } }} 
</script>

<script type="text/javascript">
$(document).ready(function(){
	//表单令牌保存
	if(typeof(Storage)!=="undefined")
	{
		var token = '{$token}';
		sessionStorage.setItem('__token__',token);
	
	} else {
		alert('浏览器不支持webStorage,提交将会出现错误');
	}	
	
	layui.use(['element','form','table','layer','laytpl'], function(){
	  var element = layui.element,
		  form = layui.form,
		  table = layui.table,
		  layer = layui.layer,
		  laytpl = layui.laytpl;
		
		//左侧菜单样式设置
		$('#menu-1').parent().addClass('layui-nav-itemed');
		$('#menu-1-0').parent().addClass('layui-this');
	  
	  table.render({
		id:'UserTable'
		,elem: '#UserList'
		,height: 'full-300'
		,url: '{:url('user/UserListData')}' //数据接口
		,page: true //开启分页
		//,toolbar:'#tableheadbar'
		,defaultToolbar:['filter']
		,cellMinWidth: 80 
		,limit: 20
		,cols: [[ //表头
		  {field: 'id', title: 'ID', sort: true, fixed: 'left',width:80}
		  ,{field: 'account', title: '登录帐号'}
		  ,{field: 'name', title: '用户名'}
		  ,{field: 'phone', title: '电话'}
		  //,{field: 'group', title: '角色',templet: '<div>{{d.group.title}}</div>'}
		  ,{field: 'status', title: '启用状态',templet: '#switchTpl',unresize: true}
		  ,{fixed: 'right', title:'操作', toolbar: '#setcol',unresize: true}
		]]
	  });
	  //添加用户弹层
	  $('#addUserBut').on('click',function(){
				layer.open({
				type: 1, 
				title:'添加用户',
				area: ['500px', '450px'],
				content: $('#addUserInfo'),
				cancel: function(index, layero){ 
					$(layero).find('input').val('');
					}
				});
			});
		//提交时对表单字段的验证
		form.verify({
			//登录帐号验证
			account: function(value, item){
				if(value.length<6){
					return '登录帐号不能小少于6个字符';
				}
				if(!new RegExp("^[a-zA-Z0-9]+$").test(value)){
					return '登录帐号不能有特殊字符';
				}	
			},
			//用户名验证
			name: function(value, item){
				if(value.length<2){
					return '用户名不能小少于2个字符';
				}
				if(!new RegExp("^[a-zA-Z0-9_\u4e00-\u9fa5]+$").test(value)){
					return '用户名不能有特殊字符';
				}
			},
			//手机号码验证
			phone: function(value, item){
				if(!new RegExp("^\\d{11}$").test(value)){
					return '手机号格式错误';
				}
			},
			//密码验证
			password: function(value, item){
				if(value.length<6){
					return '密码不能少于6个字符';
				}
				if(!new RegExp("^[a-zA-Z0-9~!@#$%^&*]+$").test(value)){
					return '请使用英文字符和数字加“~!@#$%^&*”';
				}
			}
		});
		//编辑用户提交
		form.on('submit(editSubmit)', function(obj){
			obj.field['__token__'] = sessionStorage.getItem('__token__');
			$.ajax({
				type:"POST",
				url:"{:url('user/EditUser')}",
				data:obj.field,
				dataType:'json',
				success:function(data){
					if(data.status==1){		
						//特别注意这里手册上没有写明，layer.close(index)中的index显示的是数字
						//layer每开一个层就会加1，要准确关闭的话，就要获取，这个层的‘times’属性的值
						layer.close($(obj.elem).parents('.layui-layer-page').attr('times'));
						layer.msg(data.message);
						table.reload('UserTable');
					}else{				
						layer.msg(data.message);
						
					}
				},
				complete:function(xmlHttpRequest){
					var token = xmlHttpRequest.getResponseHeader('__token__');
					//console.log('__token__响应头字段：'+ token);	
					sessionStorage.setItem('__token__',token);
				}
			});
			return false;
		});
		//添加用户提交
		form.on('submit(addSubmit)', function(obj){
			obj.field['__token__'] = sessionStorage.getItem('__token__');
			$.ajax({
				type:"POST",
				url:"{:url('user/AddUser')}",
				data:obj.field,
				dataType:'json',
				success:function(data){
					if(data.status==1){		
						//特别注意这里手册上没有写明，layer.close(index)中的index显示的是数字
						//layer每开一个层就会加1，要准确关闭的话，就要获取，这个层的‘times’属性的值
						layer.close($(obj.elem).parents('.layui-layer-page').attr('times'));
						layer.msg(data.message);
						table.reload('UserTable');
						$(obj.elem).parents('.layui-form').find('input').val('');
					}else{				
						layer.msg(data.message);
						
					}
				},
				complete:function(xmlHttpRequest){
					var token = xmlHttpRequest.getResponseHeader('__token__');
					//console.log('__token__响应头字段：'+ token);	
					sessionStorage.setItem('__token__',token);
				}
			});
			return false;
		});
		//设置角色提交
		form.on('submit(authSubmit)', function(obj){
			$.ajax({
				type:"POST",
				url:"{:url('user/SetAuth')}",
				data:obj.field,
				dataType:'json',
				success:function(data){
					if(data.status==1){		
						//特别注意这里手册上没有写明，layer.close(index)中的index显示的是数字
						//layer每开一个层就会加1，要准确关闭的话，就要获取，这个层的‘times’属性的值
						layer.close($(obj.elem).parents('.layui-layer-page').attr('times'));
						layer.msg(data.message);
						table.reload('UserTable');
						$(obj.elem).parents('.layui-form').find(':text').val('');
					}else{				
						layer.msg(data.message);
						
					}
				}
			});
			return false;
		});
		//表中工具栏编辑\设置角色\更改密码\删除
		table.on('tool(UserList)', function(obj){
			var data = obj.data; //获得当前行数据
			var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）

			//点击编辑按钮
			if(layEvent === 'edit'){
				form.val("editUserForm", {
					'id':data['id'],
					'account':data['account'],
					'name':data['name'],
					'phone':data['phone'],
					'status':data['status']	
				});
				layer.open({
				type: 1, 
				title:'编辑用户',
				area: ['500px', '450px'],
				content: $('#editUserInfo'),
				});
			}
			//设置角色
			else if(layEvent === 'setAuth'){
				form.val("setAuthForm", {
					'id':data['id'],
					'account':data['account'],
					'name':data['name'],
				});
				//判断角色选项
				var groupIdList = []; 
				$.each(data['group'],function(index, value){
					groupIdList.push(value['group_id'].toString());
				});
				$('#setAuthInfo').find('input[name^="group_id"]').each(function(index,elem){
					if(groupIdList.includes($(this).val())){
						$(this).prop('checked',true);
					}else{
						$(this).prop('checked',false);
					}
				});
				form.render('checkbox','setAuthForm');
				
				layer.open({
				type: 1, 
				title:'编辑用户',
				area: ['500px', '450px'],
				content: $('#setAuthInfo'),
				});
			}
			//点击更改密码
			else if(layEvent === 'passwordCh'){
				layer.prompt({
				  formType: 1,
				  title: '更改密码',
				  area: ['300px', '200px'] //自定义文本域宽高
				}, function(value, index, elem){
				  $.ajax({
					type:"POST",
					url:"{:url('user/PasswordChange')}",
					data:{'id':data['id'],'password':value,'__token__':sessionStorage.getItem('__token__')},
					dataType:'json',
					success:function(data){
						if(data.status==1){	
							layer.close(index);
							layer.msg(data.message);
						}else{				
							layer.msg(data.message);
						}
					},
					complete:function(xmlHttpRequest){
						var token = xmlHttpRequest.getResponseHeader('__token__');
						//console.log('__token__响应头字段：'+ token);	
						sessionStorage.setItem('__token__',token);
					}
					}); 
				});
			}
			//点击删除按钮
			else if(layEvent === 'dele'){
				layer.prompt({
				  formType: 0,
				  title: '请输入用户名确认删除',
				  area: ['300px', '200px'] //自定义文本域宽高
				}, function(value, index, elem){
					if(value==data['name']){
					  $.ajax({
						type:"POST",
						url:"{:url('user/DeleUser')}",
						data:{'id':data['id']},
						dataType:'json',
						success:function(data){
							if(data.status==1){	
								layer.close(index);
								layer.msg(data.message);
								table.reload('UserTable');
							}else{				
								layer.msg(data.message);
							}
						}
						});
					}else{
						layer.msg('输入的用户名和当前要删除的用户名不一致');
					}				
				});
			}
		});
	  //数据表格中的状态切换按钮
		form.on('switch(status)', function(obj){
			if(obj.elem.checked===true){
				var status = 1;
			}else if(obj.elem.checked===false){
				var status = 0;
			}
			$.ajax({
					type:"POST",
					url:"{:url('user/StatusChange')}",
					data:{'id':obj.value,'status':status},
					dataType:'json',
					success:function(data){
						if(data.status==1){	
							layer.msg('已'+(obj.elem.checked===true?'启用':'停用'));
						}else{				
							layer.msg(data.message);
							obj.elem.checked===true?$(obj.elem).prop('checked',false):$(obj.elem).prop('checked',true);
							form.render('checkbox');
						}
					}
				});
		
		});
		//点击搜索
		$('#search').on('click',function(){
				table.reload('UserTable', {
				  url:"{:url('user/UserSearchData')}"
				  ,where: { //设定异步数据接口的额外参数，任意设
					searchAccount: $('#searchAccount').val()
					,searchName: $('#searchName').val()
					,searchPhone: $('#searchPhone').val()
					,searchGroupId: $('#searchGroupId').val()
				  }
				  ,page: {
					curr: 1 //重新从第 1 页开始
				  }
				  ,text: {
					none: '暂无相关数据' //默认：无数据。
				  }
				});
			});
	});
});
</script>
<!--/请在上方写此页面业务相关的脚本-->
{/block}

</body>
</html>